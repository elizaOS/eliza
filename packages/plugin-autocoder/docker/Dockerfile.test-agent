# ElizaOS Test Agent
FROM node:20-alpine AS base

# Install system dependencies including testing tools
RUN apk add --no-cache \
    git \
    curl \
    bash \
    python3 \
    make \
    g++ \
    chromium \
    && rm -rf /var/cache/apk/*

# Install testing frameworks and tools
RUN npm install -g \
    vitest \
    playwright \
    jest \
    cypress \
    @testing-library/react \
    @testing-library/jest-dom

# Set Puppeteer to use installed Chromium
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

# Create eliza user
RUN addgroup -g 1001 -S eliza && \
    adduser -S eliza -u 1001 -G eliza

# Set working directory
WORKDIR /workspace

# Copy package files for dependency installation
COPY package*.json ./
COPY packages/core/package.json ./packages/core/
COPY packages/plugin-autocoder/package.json ./packages/plugin-autocoder/

# Install dependencies
RUN npm ci --only=production && npm cache clean --force

# Copy source code
COPY --chown=eliza:eliza packages/core/ ./packages/core/
COPY --chown=eliza:eliza packages/plugin-autocoder/ ./packages/plugin-autocoder/

# Build the application
RUN npm run build

# Copy agent configuration
COPY --chown=eliza:eliza docker/agents/test-agent.json /workspace/character.json

# Create health check script
RUN echo '#!/bin/bash\ncurl -f http://localhost:${HEALTH_PORT:-8001}/health || exit 1' > /usr/local/bin/healthcheck.sh && \
    chmod +x /usr/local/bin/healthcheck.sh

# Expose ports
EXPOSE 8000 8001

# Switch to eliza user
USER eliza

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /usr/local/bin/healthcheck.sh

# Start the agent
CMD ["node", "packages/core/dist/index.js", "--character", "/workspace/character.json"]