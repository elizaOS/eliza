# ElizaOS RAG Plugin

This plugin provides Retrieval Augmented Generation (RAG) capabilities for ElizaOS agents. It allows agents to ingest documents, generate embeddings, store them in a vector database, and use this knowledge to enhance their responses.

## Core Functionality

- **Document Ingestion**: Supports various file types including PDF, DOCX, and plain text formats (TypeScript, Python, YAML, JSON, Markdown, CSV).
- **Text Extraction**: Automatically extracts text content from supported document types.
- **Chunking**: Splits extracted text into manageable chunks for efficient embedding and retrieval.
- **Embedding Generation**: Uses OpenAI models (specifically `text-embedding-3-small`) to generate embeddings for text chunks.
- **Contextual Embeddings (Optional)**: Can enhance chunks with context generated by LLMs (Anthropic or OpenRouter models) before embedding. This feature can be enabled via environment variables.
- **Vector Storage**: Stores document metadata and embeddings in a configurable database (PGlite or PostgreSQL).
- **Asynchronous Processing**: Uses worker threads for heavy tasks like PDF parsing, text extraction, and embedding generation to avoid blocking the main agent process.

## Setup

### Prerequisites

- Node.js and bun
- Access to OpenAI, Anthropic, and/or OpenRouter API keys depending on the desired configuration.

### Installation

1.  Clone the repository or add this plugin package to your ElizaOS project.
2.  Install dependencies:
    ```bash
    bun install
    ```

### Environment Variables

Create a `.env` file in the root of your project (or configure these variables in your deployment environment).

**Mandatory for Core Functionality:**

- `OPENAI_API_KEY`: Your API key for OpenAI, used for generating text embeddings.

**For Database Configuration (choose one or configure PGLITE_DATA_DIR):**

- `POSTGRES_URL`: Connection string for your PostgreSQL database.
  - Example: `postgresql://user:password@host:port/database`
- `PGLITE_DATA_DIR`: Path to the directory where PGlite database files will be stored if `POSTGRES_URL` is not provided.
  - Example: `./.eliza-data/pglite-rag` (The plugin will create agent-specific subdirectories).
  - If neither `POSTGRES_URL` nor `PGLITE_DATA_DIR` is set, the plugin defaults to a path like `./.eliza-data/pglite/[agentId]`.

**For Optional Contextual RAG Feature:**

If you enable `CTX_RAG_ENABLED`, you'll need API keys for either Anthropic or OpenRouter.

- `CTX_RAG_ENABLED`: Set to `true` to enable contextual summaries for chunks before embedding. Defaults to `false`.
- `CTX_RAG_MODEL`: (Optional) Specifies the model to use for generating contextual summaries.

  - Defaults to `claude-3-haiku-20240307` (Anthropic) if `CTX_RAG_ENABLED` is true and no specific provider/model is set for `generateSmallText` via other environment variables.
  - Can be overridden by `ANTHROPIC_SMALL_MODEL` or `OPENROUTER_SMALL_MODEL` depending on the LLM provider used for `generateSmallText`.

- **Anthropic (if used for Contextual RAG or general text generation):**

  - `ANTHROPIC_API_KEY`: Your API key for Anthropic.
  - `ANTHROPIC_SMALL_MODEL`: (Optional) Model for smaller text generation tasks (like contextual summaries). Defaults to `claude-3-haiku-20240307`.
  - `ANTHROPIC_LARGE_MODEL`: (Optional) Model for larger text generation tasks. Defaults to `claude-3-5-sonnet-latest`.
  - `ANTHROPIC_SMALL_MAX_TOKENS`: (Optional) Max tokens for small model responses. Defaults to `1024`.

- **OpenRouter (if used for Contextual RAG or general text generation):**
  - `OPENROUTER_API_KEY`: Your API key for OpenRouter.
  - `OPENROUTER_BASE_URL`: (Optional) Custom base URL for OpenRouter API.
  - `OPENROUTER_SMALL_MODEL`: (Optional) Model for smaller text generation tasks. Defaults to `google/gemini-flash`.
  - `OPENROUTER_LARGE_MODEL`: (Optional) Model for larger text generation tasks. Defaults to `google/gemini-pro`.
  - `OPENROUTER_SMALL_MAX_TOKENS`: (Optional) Max tokens for small model responses. Defaults to `1024`.

**Optional OpenAI Configuration:**

- `OPENAI_BASE_URL`: (Optional) Custom base URL for OpenAI API (e.g., for proxies or self-hosted solutions).

## Development

```bash
# Start development with hot-reloading (if applicable to your setup)
bun run dev

# Build the plugin
bun run build

# Test the plugin
bun run test
```

## Publishing (Standard ElizaOS Plugin Steps)

Before publishing your plugin to the ElizaOS registry, ensure you meet these requirements:

1.  **GitHub Repository**

    - Create a public GitHub repository for this plugin.
    - Add the 'elizaos-plugins' topic to the repository.
    - Use 'main' as the default branch.

2.  **Required Assets**

    - Add images to an `images/` directory (if you plan to publish formally):
      - `logo.jpg` (400x400px square, <500KB)
      - `banner.jpg` (1280x640px, <1MB)

3.  **Publishing Process**

    ```bash
    # Check if your plugin meets all registry requirements
    npx elizaos publish --test

    # Publish to the registry
    npx elizaos publish
    ```

    After publishing, your plugin will be submitted as a pull request to the ElizaOS registry for review.

## Configuration (package.json)

The `agentConfig` section in `package.json` defines parameters your plugin might require at runtime, which can be populated from environment variables or other configurations managed by ElizaOS. The RAG plugin primarily relies on environment variables for its core API keys and settings.

Example snippet (actual parameters might vary based on your plugin's specific needs registered with ElizaOS):

```json
"agentConfig": {
  "pluginType": "elizaos:plugin:1.0.0",
  "pluginParameters": {
    "PGLITE_DATA_DIR": {
      "type": "string",
      "description": "Directory for PGlite data. Overridden by POSTGRES_URL if set."
    },
    "POSTGRES_URL": {
        "type": "string",
        "description": "PostgreSQL connection URL."
    }
  }
}
```

Customize this section if your plugin needs to expose specific configurations to the ElizaOS agent beyond what's managed by environment variables directly.

## Documentation

Provide clear documentation about:

- What your plugin does
- How to use it
- Required API keys or credentials
- Example usage
