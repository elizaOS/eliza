name: Claude Code Review

# Cancel previous runs for the same PR/branch
concurrency:
  group: claude-code-review-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, ready_for_review, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

  # Allow manual triggering for when you specifically want a review
  workflow_dispatch:

jobs:
  claude-review:
    # Skip review if PR title contains [skip-review] or is a draft
    if: |
      !contains(github.event.pull_request.title, '[skip-review]') &&
      github.event.pull_request.draft != true

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch enough history to see recent commits and check resolved issues
          fetch-depth: 50

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"

          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            Review this PR. Be concise and actionable.

            **üîÑ BEFORE REVIEWING - CHECK PREVIOUS CONTEXT:**
            1. Check all previous review comments and discussions on this PR
            2. Check formal reviews and their status (approved, changes requested, etc.)
            3. Check recent commits that may have addressed previously raised issues
            4. **DO NOT repeat issues that have been:**
               - Already commented on in this PR
               - Fixed in subsequent commits (look for "fix", "address", "resolve" in commit messages)
               - Acknowledged by the author as intentional
            5. If a previous issue was raised but not fixed, you may reference it briefly with "Still unresolved: [issue]"

            **üö® CRITICAL CHECKS:**
            - Security: hardcoded keys, SQL injection, XSS
            - No tests = REJECT (untested code is broken)
            - Wrong tools: npm/pnpm/yarn/jest/vitest = REJECT
            - Breaking changes without migration = REJECT

            **‚úÖ REQUIRED:**
            - TypeScript types (no 'any')
            - Tests with bun test ONLY
            - Use @elizaos/core imports (not packages/core)
            - Functional code (no classes)
            - Error handling

            **üìã VERIFY:**
            - All new code has tests
            - bun commands only in package.json
            - No circular dependencies
            - Follows existing patterns
            - Docs updated if needed

            **üéØ OUTPUT FORMAT:**
            ```
            ‚ùå CRITICAL: [issue] ‚Üí Fix: [specific action]
            ‚ö†Ô∏è IMPORTANT: [issue] ‚Üí Fix: [specific action]
            üí° SUGGESTION: [improvement] ‚Üí Consider: [action]
            ‚úÖ RESOLVED: [previously raised issue now fixed in commit xyz]
            ```

            Skip explanations. List only NEW issues with fixes. Acknowledge resolved issues briefly.

          # Allow Claude to run all bash and gh commands during review
          allowed_tools: 'Bash(*),Bash(gh *)'
