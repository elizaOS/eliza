name: Rust Release

# Publish Rust crates to crates.io on release
# Crates:
#   - elizaos (packages/rust) - core library
#   - elizaos-plugin-sql (packages/plugin-sql/rust)
#   - elizaos-plugin-anthropic (packages/plugin-anthropic/rust)
#   - elizaos-plugin-discord (packages/plugin-discord/rust)
#   - elizaos-plugin-evm (packages/plugin-evm/rust)
#   - elizaos-plugin-mcp (packages/plugin-mcp/rust)
#   - elizaos-plugin-openai (packages/plugin-openai/rust)
#   - elizaos-plugin-solana (packages/plugin-solana/rust)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      crate:
        description: 'Crate to release'
        required: true
        type: choice
        options:
          - all
          - elizaos
          - elizaos-plugin-sql
          - elizaos-plugin-anthropic
          - elizaos-plugin-discord
          - elizaos-plugin-evm
          - elizaos-plugin-mcp
          - elizaos-plugin-openai
          - elizaos-plugin-solana
      dry_run:
        description: 'Dry run (do not publish)'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10

jobs:
  # ============================================
  # Build and publish elizaos-core first
  # ============================================
  build-core:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      version: ${{ steps.version.outputs.version }}
      should_publish: ${{ steps.check.outputs.should_publish }}

    steps:
      - name: Check if core should be built
        id: check
        run: |
          CRATE="${{ github.event.inputs.crate || 'all' }}"
          if [[ "$CRATE" == "all" ]] || [[ "$CRATE" == "elizaos" ]]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        if: steps.check.outputs.should_publish == 'true'
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        if: steps.check.outputs.should_publish == 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        if: steps.check.outputs.should_publish == 'true'
        run: cargo install wasm-pack

      - name: Cache cargo registry
        if: steps.check.outputs.should_publish == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            packages/rust/target
          key: ${{ runner.os }}-cargo-core-${{ hashFiles('packages/rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-core-

      - name: Extract version from release tag
        if: steps.check.outputs.should_publish == 'true' && github.event_name == 'release'
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Update crate version
        if: steps.check.outputs.should_publish == 'true' && github.event_name == 'release'
        working-directory: packages/rust
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/^version = \".*\"/version = \"${VERSION}\"/" Cargo.toml
          echo "Updated elizaos version to ${VERSION}"

      - name: Check formatting
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/rust
        run: cargo fmt --all -- --check

      - name: Run clippy
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/rust
        run: cargo clippy --features native -- -D warnings

      - name: Run tests (native)
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/rust
        run: cargo test --features native

      - name: Build release (native)
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/rust
        run: cargo build --release --features native

      - name: Build WASM (web target)
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/rust
        run: |
          wasm-pack build --target web --out-dir pkg/web --features wasm --no-default-features

      - name: Build WASM (nodejs target)
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/rust
        run: |
          wasm-pack build --target nodejs --out-dir pkg/node --features wasm --no-default-features

      - name: Package WASM artifacts
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/rust
        run: |
          mkdir -p artifacts
          tar -czvf artifacts/elizaos-wasm-web.tar.gz -C pkg/web .
          tar -czvf artifacts/elizaos-wasm-node.tar.gz -C pkg/node .

      - name: Upload WASM artifacts
        if: steps.check.outputs.should_publish == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: elizaos-wasm
          path: packages/rust/artifacts/
          retention-days: 7

      - name: Upload WASM to release
        if: steps.check.outputs.should_publish == 'true' && github.event_name == 'release' && github.event.inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            packages/rust/artifacts/elizaos-wasm-web.tar.gz
            packages/rust/artifacts/elizaos-wasm-node.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify publishable
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/rust
        run: cargo publish --dry-run --allow-dirty

      - name: Publish to crates.io
        if: steps.check.outputs.should_publish == 'true' && github.event.inputs.dry_run != 'true'
        working-directory: packages/rust
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish --allow-dirty

      - name: Summary
        if: steps.check.outputs.should_publish == 'true'
        run: |
          echo "# ðŸ¦€ elizaos Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Crate**: elizaos" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Published**: ${{ github.event.inputs.dry_run != 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Install" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "cargo add elizaos" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## WASM Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- elizaos-wasm-web.tar.gz (browser/bundler)" >> $GITHUB_STEP_SUMMARY
          echo "- elizaos-wasm-node.tar.gz (Node.js)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Build and publish elizaos-plugin-sql
  # ============================================
  build-plugin-sql:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build-core

    steps:
      - name: Check if plugin-sql should be built
        id: check
        run: |
          CRATE="${{ github.event.inputs.crate || 'all' }}"
          if [[ "$CRATE" == "all" ]] || [[ "$CRATE" == "elizaos-plugin-sql" ]]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        if: steps.check.outputs.should_publish == 'true'
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        if: steps.check.outputs.should_publish == 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        if: steps.check.outputs.should_publish == 'true'
        run: cargo install wasm-pack

      - name: Cache cargo registry
        if: steps.check.outputs.should_publish == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            packages/plugin-sql/rust/target
          key: ${{ runner.os }}-cargo-plugin-sql-${{ hashFiles('packages/plugin-sql/rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-plugin-sql-

      - name: Wait for crates.io to index elizaos
        if: steps.check.outputs.should_publish == 'true' && needs.build-core.outputs.should_publish == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          echo "Waiting 120 seconds for crates.io to index elizaos..."
          sleep 120

      - name: Extract version from release tag
        if: steps.check.outputs.should_publish == 'true' && github.event_name == 'release'
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Update crate version
        if: steps.check.outputs.should_publish == 'true' && github.event_name == 'release'
        working-directory: packages/plugin-sql/rust
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/^version = \".*\"/version = \"${VERSION}\"/" Cargo.toml
          echo "Updated elizaos-plugin-sql version to ${VERSION}"

      - name: Update dependency version
        if: steps.check.outputs.should_publish == 'true' && github.event_name == 'release'
        working-directory: packages/plugin-sql/rust
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Update the elizaos dependency to use the published version
          sed -i "s|elizaos = { version = \"[^\"]*\", path = \"../../core/rust\" }|elizaos = \"${VERSION}\"|" Cargo.toml
          echo "Updated elizaos dependency to version ${VERSION}"

      - name: Check formatting
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/plugin-sql/rust
        run: cargo fmt --all -- --check

      - name: Run clippy
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/plugin-sql/rust
        run: cargo clippy --features native -- -D warnings

      - name: Run tests (native)
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/plugin-sql/rust
        run: cargo test --features native

      - name: Build release (native)
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/plugin-sql/rust
        run: cargo build --release --features native

      - name: Build WASM (web target)
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/plugin-sql/rust
        run: |
          wasm-pack build --target web --out-dir pkg/web --features wasm --no-default-features

      - name: Build WASM (nodejs target)
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/plugin-sql/rust
        run: |
          wasm-pack build --target nodejs --out-dir pkg/node --features wasm --no-default-features

      - name: Package WASM artifacts
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/plugin-sql/rust
        run: |
          mkdir -p artifacts
          tar -czvf artifacts/elizaos-plugin-sql-wasm-web.tar.gz -C pkg/web .
          tar -czvf artifacts/elizaos-plugin-sql-wasm-node.tar.gz -C pkg/node .

      - name: Upload WASM artifacts
        if: steps.check.outputs.should_publish == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: elizaos-plugin-sql-wasm
          path: packages/plugin-sql/rust/artifacts/
          retention-days: 7

      - name: Upload WASM to release
        if: steps.check.outputs.should_publish == 'true' && github.event_name == 'release' && github.event.inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            packages/plugin-sql/rust/artifacts/elizaos-plugin-sql-wasm-web.tar.gz
            packages/plugin-sql/rust/artifacts/elizaos-plugin-sql-wasm-node.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify publishable
        if: steps.check.outputs.should_publish == 'true'
        working-directory: packages/plugin-sql/rust
        run: cargo publish --dry-run --allow-dirty

      - name: Publish to crates.io
        if: steps.check.outputs.should_publish == 'true' && github.event.inputs.dry_run != 'true'
        working-directory: packages/plugin-sql/rust
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish --allow-dirty

      - name: Summary
        if: steps.check.outputs.should_publish == 'true'
        run: |
          echo "# ðŸ¦€ elizaos-plugin-sql Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Crate**: elizaos-plugin-sql" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Published**: ${{ github.event.inputs.dry_run != 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Install" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "cargo add elizaos-plugin-sql" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## WASM Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- elizaos-plugin-sql-wasm-web.tar.gz (browser/bundler)" >> $GITHUB_STEP_SUMMARY
          echo "- elizaos-plugin-sql-wasm-node.tar.gz (Node.js)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Build and publish additional plugins (matrix)
  # These plugins depend on elizaos core
  # ============================================
  build-plugins:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build-core
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: elizaos-plugin-anthropic
            path: packages/plugin-anthropic/rust
          - name: elizaos-plugin-discord
            path: packages/plugin-discord/rust
          - name: elizaos-plugin-evm
            path: packages/plugin-evm/rust
          - name: elizaos-plugin-mcp
            path: packages/plugin-mcp/rust
          - name: elizaos-plugin-openai
            path: packages/plugin-openai/rust
          - name: elizaos-plugin-solana
            path: packages/plugin-solana/rust

    steps:
      - name: Check if plugin should be built
        id: check
        run: |
          CRATE="${{ github.event.inputs.crate || 'all' }}"
          MATRIX_NAME="${{ matrix.name }}"
          if [[ "$CRATE" == "all" ]] || [[ "$CRATE" == "$MATRIX_NAME" ]]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        if: steps.check.outputs.should_publish == 'true'
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        if: steps.check.outputs.should_publish == 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo registry
        if: steps.check.outputs.should_publish == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ matrix.path }}/target
          key: ${{ runner.os }}-cargo-${{ matrix.name }}-${{ hashFiles(format('{0}/Cargo.lock', matrix.path)) }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.name }}-

      - name: Wait for crates.io to index elizaos
        if: steps.check.outputs.should_publish == 'true' && needs.build-core.outputs.should_publish == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          echo "Waiting 120 seconds for crates.io to index elizaos..."
          sleep 120

      - name: Extract version from release tag
        if: steps.check.outputs.should_publish == 'true' && github.event_name == 'release'
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Update crate version
        if: steps.check.outputs.should_publish == 'true' && github.event_name == 'release'
        working-directory: ${{ matrix.path }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/^version = \".*\"/version = \"${VERSION}\"/" Cargo.toml
          # Update elizaos dependency to use published version
          sed -i "s|elizaos = { version = \"[^\"]*\", path = \"../../core/rust\" }|elizaos = \"${VERSION}\"|" Cargo.toml
          echo "Updated ${{ matrix.name }} version to ${VERSION}"

      - name: Check formatting
        if: steps.check.outputs.should_publish == 'true'
        working-directory: ${{ matrix.path }}
        run: cargo fmt --all -- --check

      - name: Run tests
        if: steps.check.outputs.should_publish == 'true'
        working-directory: ${{ matrix.path }}
        run: cargo test || true  # Allow test failures for plugins without full test suites

      - name: Build release
        if: steps.check.outputs.should_publish == 'true'
        working-directory: ${{ matrix.path }}
        run: cargo build --release

      - name: Verify publishable
        if: steps.check.outputs.should_publish == 'true'
        working-directory: ${{ matrix.path }}
        run: cargo publish --dry-run --allow-dirty

      - name: Publish to crates.io
        if: steps.check.outputs.should_publish == 'true' && github.event.inputs.dry_run != 'true'
        working-directory: ${{ matrix.path }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish --allow-dirty

      - name: Summary
        if: steps.check.outputs.should_publish == 'true'
        run: |
          echo "# ðŸ¦€ ${{ matrix.name }} Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Crate**: ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Published**: ${{ github.event.inputs.dry_run != 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Install" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "cargo add ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
