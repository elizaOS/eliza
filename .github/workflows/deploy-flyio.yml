name: Deploy to Fly.io

on:
  push:
    branches:
      - v2-develop
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Create .env file for deployment
        run: |
          # Copy .env.example as base template
          cp .env.example .env

          # Replace secret values using sed
          sed -i 's|^OPENAI_API_KEY=.*|OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}|' .env

          # Add production-specific settings
          echo "" >> .env
          echo "# Production deployment settings" >> .env
          echo "NODE_ENV=production" >> .env
          echo "LOG_LEVEL=info" >> .env
          if [ -n "${{ secrets.SERVER_PORT }}" ]; then
            echo "SERVER_PORT=${{ secrets.SERVER_PORT }}" >> .env
          fi

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only -a eliza-v2
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
