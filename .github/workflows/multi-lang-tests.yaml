name: Multi-Language Tests

# Test Rust and Python packages on PRs and pushes
# This workflow ensures cross-language packages are always working

on:
  push:
    branches: [main, develop]
    paths:
      - "packages/rust/**"
      - "packages/python/**"
      - "plugins/plugin-sql/rust/**"
      - "plugins/plugin-sql/python/**"
      - "packages/interop/**"
      - ".github/workflows/multi-lang-tests.yaml"
  pull_request:
    branches: [main, develop]
    paths:
      - "packages/rust/**"
      - "packages/python/**"
      - "plugins/plugin-sql/rust/**"
      - "plugins/plugin-sql/python/**"
      - "packages/interop/**"
      - ".github/workflows/multi-lang-tests.yaml"

concurrency:
  group: multi-lang-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  # ============================================
  # Rust Core Tests
  # ============================================
  rust-tests:
    name: Rust Core Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            packages/rust/target
          key: ${{ runner.os }}-cargo-elizaos-core-${{ hashFiles('packages/rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-elizaos-core-

      - name: Check formatting
        working-directory: packages/rust
        run: cargo fmt --all -- --check

      - name: Run clippy
        working-directory: packages/rust
        run: cargo clippy --all-targets -- -D warnings
        continue-on-error: true

      - name: Run tests
        working-directory: packages/rust
        run: cargo test --all-features

      - name: Build release
        working-directory: packages/rust
        run: cargo build --release

  # ============================================
  # Rust SQL Plugin Tests (with PostgreSQL + pgvector)
  # ============================================
  rust-sql-tests:
    name: Rust SQL Plugin Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: eliza_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            plugins/plugin-sql/rust/target
          key: ${{ runner.os }}-cargo-elizaos-plugin-sql-${{ hashFiles('plugins/plugin-sql/rust/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-elizaos-plugin-sql-

      - name: Check formatting
        working-directory: plugins/plugin-sql/rust
        run: cargo fmt --all -- --check

      - name: Run clippy
        working-directory: plugins/plugin-sql/rust
        run: cargo clippy --all-targets -- -D warnings
        continue-on-error: true

      - name: Run all tests with PostgreSQL (serial to avoid race conditions)
        working-directory: plugins/plugin-sql/rust
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/eliza_test
          RUST_TEST_THREADS: 1
        run: cargo test --features native

      - name: Build release
        working-directory: plugins/plugin-sql/rust
        run: cargo build --release

  # ============================================
  # Python Core Tests
  # ============================================
  python-core-tests:
    name: Python Core Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-elizaos-${{ matrix.python-version }}-${{ hashFiles('packages/python/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-elizaos-${{ matrix.python-version }}-

      - name: Install dependencies
        working-directory: packages/python
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pytest pytest-asyncio pytest-cov ruff

      - name: Run ruff (linting)
        working-directory: packages/python
        run: ruff check .
        continue-on-error: true

      - name: Run tests
        working-directory: packages/python
        run: python -m pytest tests/ -v --tb=short

  # ============================================
  # Python SQL Plugin Tests (with PostgreSQL)
  # ============================================
  python-sql-tests:
    name: Python SQL Plugin Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-elizaos-plugin-sql-${{ matrix.python-version }}-${{ hashFiles('plugins/plugin-sql/python/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-elizaos-plugin-sql-${{ matrix.python-version }}-

      - name: Install core package first
        working-directory: packages/python
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Install plugin-sql dependencies
        working-directory: plugins/plugin-sql/python
        run: |
          pip install -e ".[dev]"

      - name: Run ruff (linting)
        working-directory: plugins/plugin-sql/python
        run: |
          pip install ruff
          ruff check .
        continue-on-error: true

      - name: Run tests with PostgreSQL
        working-directory: plugins/plugin-sql/python
        env:
          DATABASE_URL: postgresql+asyncpg://test:test@localhost:5432/testdb
        run: |
          python -m pytest tests/ -v --tb=short

  # ============================================
  # WASM Build Test
  # ============================================
  wasm-build:
    name: WASM Build
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        package:
          - name: elizaos-core
            path: packages/rust
          - name: elizaos-plugin-sql
            path: plugins/plugin-sql/rust

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install wasm32 target
        run: rustup target add wasm32-unknown-unknown

      - name: Install wasm-pack
        run: |
          curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ matrix.package.path }}/target
          key: ${{ runner.os }}-wasm-${{ matrix.package.name }}-${{ hashFiles(format('{0}/Cargo.lock', matrix.package.path)) }}
          restore-keys: |
            ${{ runner.os }}-wasm-${{ matrix.package.name }}-

      - name: Build WASM
        working-directory: ${{ matrix.package.path }}
        run: |
          # Try building with wasm feature
          cargo build --target wasm32-unknown-unknown --release --features wasm || {
            echo "âš ï¸ WASM build with wasm feature failed, trying without..."
            cargo build --target wasm32-unknown-unknown --release || true
          }

  # ============================================
  # Interop Tests
  # ============================================
  interop-tests:
    name: Interop Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [rust-tests, python-core-tests]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Install dependencies
        run: bun install

      - name: Build TypeScript packages
        run: bun run build

      - name: Run TypeScript interop tests
        working-directory: packages/interop/typescript
        run: |
          npx vitest run || true

      - name: Run Python interop tests
        working-directory: packages/interop/python
        run: |
          pip install pytest pytest-asyncio
          # Install the core package first
          pip install -e ../../python
          python -m pytest tests/ -v --tb=short || true

  # ============================================
  # Summary Job
  # ============================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      [
        rust-tests,
        rust-sql-tests,
        python-core-tests,
        python-sql-tests,
        wasm-build,
        interop-tests,
      ]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "# ðŸ“Š Multi-Language Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Core Tests | ${{ needs.rust-tests.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.rust-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust SQL Tests | ${{ needs.rust-sql-tests.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.rust-sql-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Core Tests | ${{ needs.python-core-tests.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.python-core-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python SQL Tests | ${{ needs.python-sql-tests.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.python-sql-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| WASM Build | ${{ needs.wasm-build.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.wasm-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Interop Tests | ${{ needs.interop-tests.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.interop-tests.result }} |" >> $GITHUB_STEP_SUMMARY
